name: Bundle Analysis

on:
  pull_request:
    branches: [ main, master ]

jobs:
  analyze:
    name: Analyze Bundle
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build library
      run: npm run build
      
    - name: Analyze bundle size
      uses: preactjs/compressed-size-action@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        pattern: 'dist/**/*.{js,css}'
        
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read bundle analysis results
          const distPath = path.join(process.cwd(), 'dist');
          const files = fs.readdirSync(distPath);
          
          let comment = '## ðŸ“¦ Bundle Analysis\n\n';
          comment += '| File | Size |\n';
          comment += '|------|------|\n';
          
          files.forEach(file => {
            if (file.endsWith('.js') || file.endsWith('.css')) {
              const stats = fs.statSync(path.join(distPath, file));
              const sizeKB = (stats.size / 1024).toFixed(2);
              comment += `| \`${file}\` | ${sizeKB} KB |\n`;
            }
          });
          
          comment += '\n> Bundle analysis generated automatically for this PR.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
